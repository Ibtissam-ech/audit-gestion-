<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARSA MAROC - Statistiques</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --sidebar-width: 250px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        #sidebar {
            position: fixed;
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--primary-color);
            color: white;
            transition: all 0.3s;
            z-index: 1000;
            left: 0;
            top: 0;
        }
        
        #sidebar .sidebar-header {
            padding: 20px;
            background-color: var(--dark-color);
            text-align: center;
        }
        
        #sidebar ul.components {
            padding: 20px 0;
        }
        
        #sidebar ul li a {
            padding: 15px 20px;
            display: block;
            color: #fff;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        #sidebar ul li a:hover {
            background-color: var(--secondary-color);
        }
        
        #sidebar ul li.active > a {
            background-color: var(--secondary-color);
        }
        
        #content {
            width: calc(100% - var(--sidebar-width));
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: all 0.3s;
            min-height: 100vh;
        }
        
        .dashboard-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
            border: none;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .main-metric {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .progress-card {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .filter-bar {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 15px 0;
            margin-top: 30px;
            text-align: center;
        }
        
        .nav-pills .nav-link.active {
            background-color: var(--secondary-color);
        }
        
        .nav-pills .nav-link {
            color: var(--primary-color);
        }
        
        .comparison-card {
            border-left: 4px solid var(--secondary-color);
        }
        
        @media (max-width: 768px) {
            #sidebar {
                width: 80px;
                text-align: center;
            }
            
            #sidebar .sidebar-header h3 {
                display: none;
            }
            
            #sidebar ul li a span {
                display: none;
            }
            
            #sidebar ul li a i {
                margin-right: 0;
                font-size: 1.5rem;
            }
            
            #content {
                width: calc(100% - 80px);
                margin-left: 80px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="sidebar-header">
    <img src="marsamaroclogo.png" alt="MARSAMARSA MAROC Logo" style="max-width: 190px; max-height: 90px;">
</div>

        <ul class="list-unstyled components">
            <li>
                <a href="code.html">
                    <i class="fas fa-home"></i>
                    <span>Accueil</span>
                </a>
            </li>
            <li>
                <a href="dashboard.html">
                    <i class="fas fa-chart-line"></i>
                    <span>Tableau de bord</span>
                </a>
            </li>
            <li>
                <a href="planactions.html">
                    <i class="fas fa-tasks"></i>
                    <span>Plan d'actions</span>
                </a>
            </li>
            <li>
                <a href="actionsgenerales.html">
                    <i class="fas fa-list-alt"></i>
                    <span>Actions Générales</span>
                </a>
            </li>
            <li>
                <a href="sittings.html">
                    <i class="fas fa-cog"></i>
                    <span>Options</span>
                </a>
            </li>
            <li class="active">
                <a href="statistics.html">
                    <i class="fas fa-chart-bar"></i>
                    <span>Statistiques</span>
                </a>
            </li>
            <li>
                <a href="rapport.html">
                    <i class="fas fa-file-export"></i>
                    <span>Rapports</span>
                </a>
            </li>
            <li>
                <a href="profile.html">
                    <i class="fas fa-user-circle"></i>
                    <span>Profil</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Déconnexion</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <div class="dashboard-header">
            <h2>Statistiques - Analyse des Performances</h2>
            <p class="mb-0">Données détaillées et analyses des actions et performances</p>
        </div>

        <div class="filter-bar">
            <div class="row">
                <div class="col-md-3">
                    <label for="period" class="form-label">Période</label>
                    <select class="form-select" id="period">
                        <option selected>3 derniers mois</option>
                        <option>6 derniers mois</option>
                        <option>Cette année</option>
                        <option>L'année dernière</option>
                        <option>Toutes périodes</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="department" class="form-label">Département</label>
                    <select class="form-select" id="department">
                        <option selected>Tous les départements</option>
                        <option>Maintenance</option>
                        <option>Production</option>
                        <option>Qualité</option>
                        <option>Logistique</option>
                        <option>RH</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Statut</label>
                    <select class="form-select" id="status">
                        <option selected>Tous les statuts</option>
                        <option>Terminé</option>
                        <option>En cours</option>
                        <option>En retard</option>
                        <option>Planifié</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="category" class="form-label">Catégorie</label>
                    <select class="form-select" id="category">
                        <option selected>Toutes catégories</option>
                        <option>Maintenance</option>
                        <option>Sécurité</option>
                        <option>Formation</option>
                        <option>Optimisation</option>
                        <option>Audit</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary">
                    <i class="fas fa-filter me-2"></i>Appliquer les filtres
                </button>
                <button class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-download me-2"></i>Exporter les données
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h5>Total des Actions</h5>
                <div class="stat-value">127</div>
                <p>+15% vs période précédente</p>
            </div>
            <div class="stat-card">
                <h5>Taux de Completion</h5>
                <div class="stat-value">78%</div>
                <div class="progress mt-2">
                    <div class="progress-bar" role="progressbar" style="width: 78%" aria-valuenow="78" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <div class="stat-card">
                <h5>Actions en Retard</h5>
                <div class="stat-value" style="color: #e74c3c;">18</div>
                <p>14% du total</p>
            </div>
            <div class="stat-card">
                <h5>Efficacité Moyenne</h5>
                <div class="stat-value" style="color: #2ecc71;">86%</div>
                <p>+5% vs cible</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Évolution des Actions dans le Temps</h5>
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Répartition par Département</h5>
                        <div class="chart-container">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Performance par Responsable</h5>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Comparaison Objectifs vs Réalisations</h5>
                        <div class="chart-container">
                            <canvas id="goalsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card comparison-card">
                    <div class="card-body">
                        <h5 class="card-title">Indicateurs Clés de Performance (KPI)</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>KPI</th>
                                        <th>Valeur Actuelle</th>
                                        <th>Cible</th>
                                        <th>Ecart</th>
                                        <th>Tendance</th>
                                        <th>Evaluation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Taux de completion des actions</td>
                                        <td>78%</td>
                                        <td>80%</td>
                                        <td class="text-danger">-2%</td>
                                        <td><i class="fas fa-arrow-up text-success"></i> +5% vs mois dernier</td>
                                        <td><span class="badge bg-warning text-dark">En progrès</span></td>
                                    </tr>
                                    <tr>
                                        <td>Délai moyen de réalisation</td>
                                        <td>23 jours</td>
                                        <td>20 jours</td>
                                        <td class="text-danger">+3 jours</td>
                                        <td><i class="fas fa-arrow-down text-success"></i> -2 jours vs mois dernier</td>
                                        <td><span class="badge bg-warning text-dark">En amélioration</span></td>
                                    </tr>
                                    <tr>
                                        <td>Taux d'actions en retard</td>
                                        <td>14%</td>
                                        <td>10%</td>
                                        <td class="text-danger">+4%</td>
                                        <td><i class="fas fa-arrow-up text-danger"></i> +2% vs mois dernier</td>
                                        <td><span class="badge bg-danger">Attention</span></td>
                                    </tr>
                                    <tr>
                                        <td>Efficacité des ressources</td>
                                        <td>86%</td>
                                        <td>85%</td>
                                        <td class="text-success">+1%</td>
                                        <td><i class="fas fa-arrow-up text-success"></i> +3% vs mois dernier</td>
                                        <td><span class="badge bg-success">Excellent</span></td>
                                    </tr>
                                    <tr>
                                        <td>Coût par action</td>
                                        <td>1,250 DH</td>
                                        <td>1,200 DH</td>
                                        <td class="text-danger">+50 DH</td>
                                        <td><i class="fas fa-arrow-down text-success"></i> -30 DH vs mois dernier</td>
                                        <td><span class="badge bg-warning text-dark">Contrôlé</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Top 5 des Actions les Plus Efficaces</h5>
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Optimisation processus production</h6>
                                    <small class="text-muted">Département: Production</small>
                                </div>
                                <span class="badge bg-success rounded-pill">95%</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Formation sécurité nouveaux employés</h6>
                                    <small class="text-muted">Département: RH</small>
                                </div>
                                <span class="badge bg-success rounded-pill">92%</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Mise à jour système contrôle qualité</h6>
                                    <small class="text-muted">Département: Qualité</small>
                                </div>
                                <span class="badge bg-success rounded-pill">90%</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Automatisation rapports mensuels</h6>
                                    <small class="text-muted">Département: IT</small>
                                </div>
                                <span class="badge bg-success rounded-pill">88%</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Réorganisation entrepôt central</h6>
                                    <small class="text-muted">Département: Logistique</small>
                                </div>
                                <span class="badge bg-success rounded-pill">87%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Actions Requérant une Attention</h5>
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Modernisation équipement test B</h6>
                                    <small class="text-muted">En retard de 15 jours</small>
                                </div>
                                <span class="badge bg-danger rounded-pill">35%</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Audit sécurité bâtiment C</h6>
                                    <small class="text-muted">En retard de 8 jours</small>
                                </div>
                                <span class="badge bg-danger rounded-pill">40%</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Implémentation nouveau logiciel</h6>
                                    <small class="text-muted">En retard de 5 jours</small>
                                </div>
                                <span class="badge bg-warning rounded-pill">45%</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Formation équipe maintenance</h6>
                                    <small class="text-muted">Progression lente</small>
                                </div>
                                <span class="badge bg-warning rounded-pill">50%</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Révision procédures qualité</h6>
                                    <small class="text-muted">Dépassement budget</small>
                                </div>
                                <span class="badge bg-warning rounded-pill">65%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>MARSAMARSA MAROC &copy; 2023 - Tous droits réservés</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Dummy Data - In a real application, this would come from an API
            let allStatsData = {
                totalActions: 127,
                completionRate: 78,
                overdueActions: 18,
                averageEfficiency: 86,
                timeline: {
                    labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'],
                    planned: [15, 22, 18, 25, 30, 28, 35, 40, 38, 42, 45, 50],
                    realized: [12, 18, 15, 20, 25, 24, 30, 35, 32, 38, 40, 45]
                },
                departments: {
                    labels: ['Maintenance', 'Production', 'Qualité', 'Logistique', 'RH', 'IT'],
                    data: [45, 32, 18, 15, 9, 8]
                },
                performance: {
                    labels: ['J. Dupont', 'M. Lambert', 'P. Martin', 'S. Leroux', 'T. Bernard', 'L. Petit'],
                    data: [92, 85, 78, 88, 75, 80]
                },
                goals: {
                    labels: ['Completion', 'Efficacité', 'Délai (jours)', 'Coût (DH)'],
                    objectives: [80, 85, 20, 1200],
                    realizations: [78, 86, 23, 1250]
                },
                kpis: [
                    { kpi: "Taux de completion des actions", current: "78%", target: "80%", gap: "-2%", trend: "+5% vs mois dernier", evaluation: "En progrès", status: "warning" },
                    { kpi: "Délai moyen de réalisation", current: "23 jours", target: "20 jours", gap: "+3 jours", trend: "-2 jours vs mois dernier", evaluation: "En amélioration", status: "warning" },
                    { kpi: "Taux d'actions en retard", current: "14%", target: "10%", gap: "+4%", trend: "+2% vs mois dernier", evaluation: "Attention", status: "danger" },
                    { kpi: "Efficacité des ressources", current: "86%", target: "85%", gap: "+1%", trend: "+3% vs mois dernier", evaluation: "Excellent", status: "success" },
                    { kpi: "Coût par action", current: "1,250 DH", target: "1,200 DH", gap: "+50 DH", trend: "-30 DH vs mois dernier", evaluation: "Contrôlé", status: "warning" },
                ],
                topActions: [
                    { title: "Optimisation processus production", department: "Production", efficiency: 95 },
                    { title: "Formation sécurité nouveaux employés", department: "RH", efficiency: 92 },
                    { title: "Mise à jour système contrôle qualité", department: "Qualité", efficiency: 90 },
                    { title: "Automatisation rapports mensuels", department: "IT", efficiency: 88 },
                    { title: "Réorganisation entrepôt central", department: "Logistique", efficiency: 87 },
                ],
                attentionActions: [
                    { title: "Modernisation équipement test B", status: "En retard de 15 jours", progress: 35, badge: "danger" },
                    { title: "Audit sécurité bâtiment C", status: "En retard de 8 jours", progress: 40, badge: "danger" },
                    { title: "Implémentation nouveau logiciel", status: "En retard de 5 jours", progress: 45, badge: "warning" },
                    { title: "Formation équipe maintenance", status: "Progression lente", progress: 50, badge: "warning" },
                    { title: "Révision procédures qualité", status: "Dépassement budget", progress: 65, badge: "warning" },
                ]
            };

            // Chart instances (initialized once)
            let timelineChart, departmentChart, performanceChart, goalsChart;

            // Function to initialize charts
            function initializeCharts(data) {
                // Timeline Chart
                const timelineCtx = document.getElementById('timelineChart').getContext('2d');
                if (timelineChart) timelineChart.destroy(); // Destroy existing chart if it exists
                timelineChart = new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: data.timeline.labels,
                        datasets: [{
                            label: 'Actions Planifiées',
                            data: data.timeline.planned,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.3
                        }, {
                            label: 'Actions Réalisées',
                            data: data.timeline.realized,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Department Chart
                const departmentCtx = document.getElementById('departmentChart').getContext('2d');
                if (departmentChart) departmentChart.destroy();
                departmentChart = new Chart(departmentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: data.departments.labels,
                        datasets: [{
                            data: data.departments.data,
                            backgroundColor: [
                                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Performance Chart
                const performanceCtx = document.getElementById('performanceChart').getContext('2d');
                if (performanceChart) performanceChart.destroy();
                performanceChart = new Chart(performanceCtx, {
                    type: 'bar',
                    data: {
                        labels: data.performance.labels,
                        datasets: [{
                            label: 'Taux de Completion (%)',
                            data: data.performance.data,
                            backgroundColor: '#3498db',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });

                // Goals Chart
                const goalsCtx = document.getElementById('goalsChart').getContext('2d');
                if (goalsChart) goalsChart.destroy();
                goalsChart = new Chart(goalsCtx, {
                    type: 'bar',
                    data: {
                        labels: data.goals.labels,
                        datasets: [{
                            label: 'Objectifs',
                            data: data.goals.objectives,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderWidth: 1
                        }, {
                            label: 'Réalisations',
                            data: data.goals.realizations,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Function to update static cards
            function updateStatCards(data) {
                document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = data.totalActions;
                document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = data.completionRate + '%';
                document.querySelector('.stat-card:nth-child(2) .progress-bar').style.width = data.completionRate + '%';
                document.querySelector('.stat-card:nth-child(2) .progress-bar').setAttribute('aria-valuenow', data.completionRate);
                document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = data.overdueActions;
                document.querySelector('.stat-card:nth-child(4) .stat-value').textContent = data.averageEfficiency + '%';
            }

            // Function to update KPI table
            function updateKpiTable(kpis) {
                const tbody = document.querySelector('.table-responsive tbody');
                tbody.innerHTML = ''; // Clear existing rows

                kpis.forEach(kpi => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${kpi.kpi}</td>
                        <td>${kpi.current}</td>
                        <td>${kpi.target}</td>
                        <td class="${kpi.gap.includes('-') ? 'text-success' : 'text-danger'}">${kpi.gap}</td>
                        <td><i class="fas fa-${kpi.trend.includes('+') ? 'arrow-up text-success' : 'arrow-down text-danger'}"></i> ${kpi.trend}</td>
                        <td><span class="badge bg-${kpi.status} ${kpi.status === 'warning' ? 'text-dark' : ''}">${kpi.evaluation}</span></td>
                    `;
                });
            }

            // Function to update Top Actions list
            function updateTopActions(actions) {
                const listGroup = document.querySelector('.col-md-6:nth-child(1) .list-group');
                listGroup.innerHTML = '';
                actions.forEach(action => {
                    listGroup.innerHTML += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${action.title}</h6>
                                <small class="text-muted">Département: ${action.department}</small>
                            </div>
                            <span class="badge bg-success rounded-pill">${action.efficiency}%</span>
                        </div>
                    `;
                });
            }

            // Function to update Actions Requiring Attention list
            function updateAttentionActions(actions) {
                const listGroup = document.querySelector('.col-md-6:nth-child(2) .list-group');
                listGroup.innerHTML = '';
                actions.forEach(action => {
                    listGroup.innerHTML += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${action.title}</h6>
                                <small class="text-muted">${action.status}</small>
                            </div>
                            <span class="badge bg-${action.badge} rounded-pill">${action.progress}%</span>
                        </div>
                    `;
                });
            }

            // Master function to update all UI components
            function updateUI(filteredData) {
                updateStatCards(filteredData);
                initializeCharts(filteredData);
                updateKpiTable(filteredData.kpis);
                updateTopActions(filteredData.topActions);
                updateAttentionActions(filteredData.attentionActions);
            }

            // Filter Logic
            function applyFilters() {
                const period = document.getElementById('period').value;
                const department = document.getElementById('department').value;
                const status = document.getElementById('status').value;
                const category = document.getElementById('category').value;

                // In a real application, you would send these filters to your backend
                // and receive filtered data. For this example, we're simulating.

                let filteredData = JSON.parse(JSON.stringify(allStatsData)); // Deep copy to avoid modifying original

                // Simple filtering simulation
                if (department !== 'Tous les départements') {
                    // Adjust data based on department. This is a very basic simulation.
                    // For a real scenario, you'd have specific data for each department.
                    filteredData.totalActions = Math.floor(allStatsData.totalActions * 0.7);
                    filteredData.completionRate = Math.min(95, allStatsData.completionRate + 5);
                    filteredData.overdueActions = Math.floor(allStatsData.overdueActions * 0.5);
                    filteredData.averageEfficiency = Math.min(90, allStatsData.averageEfficiency + 2);

                    // Filter charts data (simplistic adjustment for demo)
                    filteredData.departments.data = filteredData.departments.labels.map(dep =>
                        dep === department ? filteredData.departments.data[allStatsData.departments.labels.indexOf(dep)] * 1.5 : filteredData.departments.data[allStatsData.departments.labels.indexOf(dep)] * 0.5
                    );
                    // Ensure data sums up, or use a more complex logic
                    let total = filteredData.departments.data.reduce((sum, val) => sum + val, 0);
                    filteredData.departments.data = filteredData.departments.data.map(val => (val / total) * allStatsData.totalActions);

                    // Filter lists based on department (if they have department info)
                    filteredData.topActions = allStatsData.topActions.filter(action => action.department === department || department === 'Tous les départements');
                    filteredData.attentionActions = allStatsData.attentionActions.filter(action => {
                        // Assuming attention actions don't have department directly,
                        // this would be more complex to filter realistically.
                        // For demo, we'll just show some if a specific department is selected.
                        return department !== 'Tous les départements' ? action.progress < 50 : true;
                    });
                }
                
                if (status !== 'Tous les statuts') {
                    // Similar adjustments for status
                    if (status === 'Terminé') {
                        filteredData.totalActions = Math.floor(allStatsData.totalActions * 0.8);
                        filteredData.completionRate = 95;
                        filteredData.overdueActions = 0;
                    } else if (status === 'En retard') {
                        filteredData.totalActions = Math.floor(allStatsData.totalActions * 0.4);
                        filteredData.completionRate = 40;
                        filteredData.overdueActions = Math.floor(allStatsData.totalActions * 0.6);
                    }
                }

                // Add a visual indicator that filters are active
                const filterButton = document.querySelector('.btn-primary');
                if (period !== '3 derniers mois' || department !== 'Tous les départements' || status !== 'Tous les statuts' || category !== 'Toutes catégories') {
                    filterButton.classList.add('btn-warning');
                    filterButton.classList.remove('btn-primary');
                    filterButton.innerHTML = `<i class="fas fa-filter me-2"></i>Filtres actifs`;
                } else {
                    filterButton.classList.remove('btn-warning');
                    filterButton.classList.add('btn-primary');
                    filterButton.innerHTML = `<i class="fas fa-filter me-2"></i>Appliquer les filtres`;
                }

                updateUI(filteredData);
            }

            // Event listener for the Apply Filters button
            document.querySelector('.btn-primary').addEventListener('click', applyFilters);

            // Initial load of all data
            updateUI(allStatsData);
        });
    </script>
</body>
</html>